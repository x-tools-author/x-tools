name: build-release
on:
  push:
    tags:
      - 'v*'
env:
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  DOCKER_IMAGE: ghcr.io/x-tools-author/x-tools-ubuntu-20.04:x86_64
  QT_VERSION: '6.8.3'
  QT_MODULES: 'qtcharts qtserialbus qtserialport qtwebsockets'
  QT_ANDROID_KEYSTORE_PATH: res/android/android_release.keystore
  QT_ANDROID_KEYSTORE_ALIAS: ${{ secrets.ANDROID_KEYSTORE_ALIAS }}
  QT_ANDROID_KEYSTORE_STORE_PASS: ${{ secrets.ANDROID_KEYSTORE_STORE_PASS }}
  QT_ANDROID_KEYSTORE_KEY_PASS: ${{ secrets.ANDROID_KEYSTORE_KEY_PASS }}

jobs:
  update-release:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout
      uses: actions/checkout@v4
    - name: Delete Release
      run: |
        gh release delete continuous -y || true
        gh release delete ${{ github.ref_name }} -y || true
    - name: Create Release
      run: |
        gh release create ${{ github.ref_name }} --title "Release ${{ github.ref_name }}" --notes "The version is ready. You can see the changed log: https://github.com/x-tools-author/x-tools/blob/master/res/files/history.txt"
  release-for-windows:
    runs-on: windows-2022
    needs: update-release
    name: Release for Windows
    strategy:
      fail-fast: false
      matrix:
        ci_action: [
          'Windows',
          'Windows7',
          'WindowsXP'
        ]
    steps:
      - name: Pull code
        uses: actions/checkout@v4
      - name: Setup cmake
        uses: jwlawson/actions-setup-cmake@v2
        with:
          cmake-version: '4.1.x'
      - name: Use cmake
        run: cmake --version
      - name: Build for Windows
        if: ${{ matrix.ci_action == 'Windows' }}
        uses: ./.github/actions/ci-windows
        with:
          tag: ${{ github.ref_name }}
      - name: Build for Windows 7
        if: ${{ matrix.ci_action == 'Windows7' }}
        uses: ./.github/actions/ci-windows-7
        with:
          tag: ${{ github.ref_name }}
      - name: Build for Windows XP
        if: ${{ matrix.ci_action == 'WindowsXP' }}
        uses: ./.github/actions/ci-windows-xp
        with:
          tag: ${{ github.ref_name }}
  release-for-linux-arm:
    runs-on: ubuntu-24.04-arm
    needs: update-release
    steps:
    - name: Checkout
      uses: actions/checkout@v4
    - name: Install Dependencies
      run: |
        sudo apt-get install -y libxcb-xinerama0 libxcb-cursor-dev libudev-dev libusb-dev libusb-1.0-0-dev ninja-build
        wget https://github.com/probonopd/linuxdeployqt/releases/download/continuous/linuxdeployqt-continuous-aarch64.AppImage -O ${{ github.workspace }}/cmake/linux/tools/linuxdeployqt-aarch64
        chmod +x ${{ github.workspace }}/cmake/linux/tools/linuxdeployqt-aarch64
      shell: bash
    - name: Build for Linux ARM
      run: |
        docker run --rm --privileged -v ${{ github.workspace }}:/workspace ghcr.io/x-tools-author/x-tools-ubuntu-22.04-arm64:arm64 /bin/bash -c "\
        cd /workspace && git --version && ls /opt/qt/6.7.3 && chmod +x ./scripts/ci-build-ubuntu-22.04-arm64.sh && ./scripts/ci-build-ubuntu-22.04-arm64.sh"
      shell: bash
    - name: Upload Release Asset for Linux ARM
      run: |
        dir bin/6.7.3/Linux/Release
        find bin/6.7.3/Linux/Release/xTools-linux -name "*.deb" -exec gh release upload ${{ github.ref_name }} {} \;
        find bin/6.7.3/Linux/Release/xTools-linux -name "*.AppImage" -exec gh release upload ${{ github.ref_name }} {} \;
      shell: bash
  release-for-linux:
    runs-on: ubuntu-22.04
    needs: update-release
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        ref: ${{ github.ref }}
    - name: Build for Linux
      run: |
          git fetch --tags
          docker run --rm --privileged -v ${{ github.workspace }}:/workspace ${{ env.DOCKER_IMAGE }} /bin/bash -c "\
          cd /workspace && git config --global --add safe.directory /workspace && git tag -d continuous && chmod +x ./scripts/ci-build-ubuntu-20.04.sh && ./scripts/ci-build-ubuntu-20.04.sh"
    - name: Upload Release Asset for Linux
      run: |
        dir bin/${{env.QT_VERSION}}/Linux/Release
        find bin/${{env.QT_VERSION}}/Linux/Release/xTools-linux -name "*.deb" -exec gh release upload  ${{ github.ref_name }} {} \;
        find bin/${{env.QT_VERSION}}/Linux/Release/xTools-linux -name "*.AppImage" -exec gh release upload  ${{ github.ref_name }} {} \;
  release-for-macos:
    runs-on: macos-14
    needs: update-release
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        ref: ${{ github.ref }}
    - name: Install Qt for macOS
      uses: jurplel/install-qt-action@v4
      with:
        version: '${{env.QT_VERSION}}'
        target: 'desktop'
        arch: 'clang_64'
        dir: ${{ github.workspace }}
        modules: 'qtcharts qtserialbus qtserialport qtwebsockets'
    - name: Build for macOS
      # 278ERROR: no file at "/usr/local/opt/libiodbc/lib/libiodbc.2.dylib"
      # brew unlink unixodbc
      # brew install libiodbc
      # ERROR: no file at "/Applications/Postgres.app/Contents/Versions/14/lib/libpq.5.dylib"
      # ln -s /usr/local/Cellar/postgresql@14/14.10/lib/postgresql@14/libpq.5.14.dylib /Applications/Postgres.app/Contents/Versions/14/lib/libpq.5.dylib
      run: |
        git fetch --tags
        # brew unlink unixodbc
        # brew install libiodbc
        mkdir -p /Applications/Postgres.app/Contents/Versions/14/lib
        ln -s /usr/local/Cellar/postgresql@14/14.10/lib/postgresql@14/libpq.5.14.dylib /Applications/Postgres.app/Contents/Versions/14/lib/libpq.5.dylib
        mkdir build
        cd build
        cmake ../ -DCMAKE_PREFIX_PATH='${{ github.workspace }}/Qt/${{env.QT_VERSION}}/clang_64/lib/cmake/Qt6' -DCMAKE_BUILD_TYPE:STRING=Release
        cmake --build . --target all
        cmake --build . --target xTools_dmg
    - name: Upload Release Asset for macOS
      run: |
        ls bin/${{env.QT_VERSION}}/Darwin/Release/xTools
        find bin/${{env.QT_VERSION}}/Darwin/Release/xTools -name "*.dmg" -exec gh release upload ${{ github.ref_name }} {} \;
  release-for-android:
    runs-on: ubuntu-24.04
    needs: update-release
    steps:
    - name: Checkout
      uses: actions/checkout@v4
    - name: Setup cmake
      uses: jwlawson/actions-setup-cmake@v2
      with:
        cmake-version: '4.1.x'
    - name: Build for Android
      run: |
        docker pull ${{ env.DOCKER_IMAGE }}
        docker run --rm -v ${{ github.workspace }}:/workspace ${{ env.DOCKER_IMAGE }} /bin/bash -c "\
        cd /workspace && chmod +x ./scripts/ci-build-android-armv7.sh && ./scripts/ci-build-android-armv7.sh \
        ${{env.QT_ANDROID_KEYSTORE_PATH}} ${{env.QT_ANDROID_KEYSTORE_ALIAS}} ${{env.QT_ANDROID_KEYSTORE_STORE_PASS}} ${{env.QT_ANDROID_KEYSTORE_KEY_PASS}}"
    - name: Upload Release Asset for Android
      run: |
        cmake -E copy build/armeabi_v7a/android-build/build/outputs/apk/release/android-build-release-signed.apk xtools-android-armeabi_v7a.apk
        ls && tree build/armeabi_v7a && gh release upload ${{ github.ref_name }} xtools-android-armeabi_v7a.apk
